<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FHIR Request Builder</title>

<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0; padding: 0;
    background: #f5f7fa;
  }
  .app {
    max-width: 1100px;
    margin: 2rem auto;
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 0 30px #0002;
  }
  h1 { margin-top: 0; font-size: 1.9rem; }
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap: 1rem; }
  input, select, textarea {
    width: 100%; padding: .55rem;
    border-radius: 8px; border: 1px solid #ccc;
    box-sizing: border-box;
  }
  textarea { min-height: 120px; font-family: monospace; }
  .section-title { margin-top: 2rem; font-weight: bold; font-size: 1.2rem; }
  .resource-list-box {
    background: #fafafa; border: 1px solid #ddd;
    padding: 1rem; border-radius: 8px;
    max-height: 260px; overflow-y: auto;
  }
  .resource-item {
    background:white; border:1px solid #ddd;
    padding:6px 8px; border-radius:6px;
    margin-bottom:6px; font-size:.9rem;
  }
  button {
    padding:.45rem 1rem; border-radius:999px;
    border:none; cursor:pointer; font-weight:600;
  }
  button.primary { background:#2563eb; color:white; }
  button.secondary { background:#e5e7eb; }
  .btn-row { margin-top: 1rem; display:flex; gap:1rem; flex-wrap:wrap; }
  .copy-btn {
    float:right; padding:0.35rem 0.75rem;
    background:#ddd; border-radius:6px; cursor:pointer;
    font-size: 0.8rem;
  }
</style>
</head>

<body>
<div class="app">
<h1>FHIR Request Builder</h1>
<p>Build FHIR R4‚Äìcompliant resources and bundles (batch/transaction) with presets and resource-specific fields. Currently tested with HAPI FHIR Server</p>

<!-- ===========================
     BASIC SETTINGS
=========================== -->
<div class="section-title">Basic Resource Settings</div>

<div class="grid">
  <div>
    <label>FHIR Base URL</label>
    <input id="baseUrl" value="https://hapi.fhir.org/baseR4">
  </div>

  <div>
    <label>Resource Type</label>
    <select id="resourceType">
      <option value="AllergyIntolerance">AllergyIntolerance</option>
      <option value="Procedure">Procedure</option>
      <option value="Immunization">Immunization</option>
      <option value="Condition">Condition</option>
      <option value="MedicationRequest">MedicationRequest</option>
      <option value="MedicationStatement">MedicationStatement</option>
      <option value="Observation">Observation</option>
      <option value="Appointment">Appointment</option>
    </select>
  </div>

  <div>
    <label>Preset Example</label>
    <select id="examplePreset"></select>
  </div>

  <div>
    <label>Patient ID</label>
    <input id="patientId" placeholder="e.g. 53328400">
  </div>

  <div>
    <label>Practitioner ID (for Appointment)</label>
    <input id="practitionerId" placeholder="optional">
  </div>

  <div>
    <label>Code</label>
    <input id="customCode" placeholder="auto-filled by preset">
  </div>

  <div>
    <label>Display</label>
    <input id="customDisplay" placeholder="auto-filled by preset">
  </div>

  <div>
    <label>Date</label>
    <input id="dateValue" type="date">
  </div>

  <div>
    <label>Value / Dosage (optional)</label>
    <input id="valueField" placeholder="e.g. 8.1 or ‚Äú500 mg twice daily‚Äù">
  </div>
</div>

<!-- ===========================
     RESOURCE-SPECIFIC FIELDS
=========================== -->
<div class="section-title">Resource-Specific Fields</div>
<div id="dynamicFields"
  class="grid"
  style="padding:10px; background:#f9fafb; border:1px solid #ddd; border-radius:8px;">
</div>

<!-- ===========================
     BUNDLE BUILDING
=========================== -->
<div class="btn-row">
  <button class="secondary" id="addResourceBtn">‚ûï Add Resource to Bundle</button>
</div>

<div>
  <h3>Resources in Bundle</h3>
  <div id="resourceList" class="resource-list-box"></div>

  <label>Bundle Type</label>
  <select id="bundleType">
    <option value="batch">batch</option>
    <option value="transaction" selected>transaction</option>
  </select>
</div>

<div class="btn-row">
  <button class="primary" id="generateBtn">‚öôÔ∏è Generate Output</button>
  <button class="secondary" id="clearBtn">üßπ Clear All</button>
</div>

<!-- ===========================
     OUTPUT
=========================== -->
<div class="section-title">Request URL</div>
<button class="copy-btn" data-copy="requestUrl">Copy</button>
<input id="requestUrl" readonly>

<div class="section-title">FHIR JSON Body</div>
<button class="copy-btn" data-copy="requestBody">Copy</button>
<textarea id="requestBody" readonly></textarea>

<div class="section-title">curl Command</div>
<button class="copy-btn" data-copy="curlCmd">Copy</button>
<textarea id="curlCmd" readonly></textarea>

</div>

<script>
/* -----------------------------------------------------
   Helper: safe element value
------------------------------------------------------ */
function valOr(id, fallback = "") {
  const el = document.getElementById(id);
  if (!el) return fallback;
  const v = el.value;
  return v === "" || v == null ? fallback : v;
}

/* -----------------------------------------------------
   PRESET EXAMPLES
------------------------------------------------------ */
const examples = {
  AllergyIntolerance: [
    { code:"406474003", display:"Peanut allergy", category:"food", severity:"severe" },
    { code:"300916003", display:"Pollen allergy", category:"environment", severity:"mild" },
    { code:"2670", display:"Penicillin allergy", category:"medication", severity:"moderate" }
  ],
  Procedure: [
    { code:"80146002", display:"Appendectomy" },
    { code:"43396009", display:"HbA1c measurement" },
    { code:"424153000", display:"Diabetic retinal exam" }
  ],
  Immunization: [
    { code:"140", display:"Influenza vaccine" },
    { code:"207", display:"COVID-19 mRNA vaccine" },
    { code:"133", display:"Pneumococcal conjugate" }
  ],
  Condition: [
    { code:"44054006", display:"Type 2 diabetes" },
    { code:"38341003", display:"Essential hypertension" },
    { code:"431855005", display:"CKD stage 2" }
  ],
  MedicationRequest: [
    { code:"860975", display:"Metformin 500 mg", dose:"500 mg twice daily" },
    { code:"351477", display:"Lisinopril 10 mg", dose:"10 mg daily" }
  ],
  MedicationStatement: [
    { code:"351477", display:"Lisinopril 10 mg" },
    { code:"617314", display:"Atorvastatin 20 mg" }
  ],
  Observation: [
    { code:"4548-4", display:"Hemoglobin A1c", value:"8.1", unit:"%" },
    { code:"2160-0", display:"Creatinine", value:"1.3", unit:"mg/dL" },
    { code:"33914-3", display:"eGFR", value:"70", unit:"mL/min/1.73m2" }
  ],
  Appointment: [
    { code:"FOLLOWUP", display:"Diabetes follow-up" },
    { code:"CKD", display:"CKD monitoring visit" }
  ]
};

/* -----------------------------------------------------
   Dynamic Field Templates
------------------------------------------------------ */
const dynamicFieldTemplates = {
  AllergyIntolerance: `
    <div>
      <label>Allergy Category</label>
      <select id="allergyCategory">
        <option value="food">Food</option>
        <option value="medication">Medication</option>
        <option value="environment">Environment</option>
        <option value="biologic">Biologic</option>
      </select>
    </div>
    <div>
      <label>Criticality</label>
      <select id="allergyCriticality">
        <option value="low">Low</option>
        <option value="high">High</option>
        <option value="unable-to-assess">Unable to assess</option>
      </select>
    </div>
    <div>
      <label>Reaction Severity</label>
      <select id="allergySeverity">
        <option value="mild">Mild</option>
        <option value="moderate" selected>Moderate</option>
        <option value="severe">Severe</option>
      </select>
    </div>
    <div>
      <label>Reaction Description</label>
      <input id="allergyReactionText" placeholder="e.g. rash, swelling">
    </div>
  `,
  Procedure: `
    <div>
      <label>Procedure Status</label>
      <select id="procedureStatus">
        <option value="completed">Completed</option>
        <option value="in-progress">In Progress</option>
        <option value="not-done">Not done</option>
      </select>
    </div>
  `,
  Condition: `
    <div>
      <label>Clinical Status</label>
      <select id="conditionStatus">
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="resolved">Resolved</option>
      </select>
    </div>
    <div>
      <label>Verification Status</label>
      <select id="conditionVerification">
        <option value="confirmed">Confirmed</option>
        <option value="provisional">Provisional</option>
        <option value="refuted">Refuted</option>
      </select>
    </div>
  `,
  MedicationRequest: `
    <div>
      <label>Intent</label>
      <select id="medReqIntent">
        <option value="order">Order</option>
        <option value="plan">Plan</option>
        <option value="proposal">Proposal</option>
      </select>
    </div>
    <div>
      <label>Dosage Instructions</label>
      <input id="medReqDosage" placeholder="e.g. 500 mg twice daily">
    </div>
  `,
  Observation: `
    <div>
      <label>Value</label>
      <input id="obsValue" placeholder="e.g. 8.1">
    </div>
    <div>
      <label>Unit</label>
      <input id="obsUnit" placeholder="% or mg/dL or mL/min/1.73m2">
    </div>
  `,
  Appointment: `
    <div>
      <label>Appointment Status</label>
      <select id="apptStatus">
        <option value="booked" selected>Booked</option>
        <option value="arrived">Arrived</option>
        <option value="fulfilled">Fulfilled</option>
        <option value="noshow">No-show</option>
      </select>
    </div>
    <div>
      <label>Description</label>
      <input id="apptDescription" placeholder="Follow-up visit">
    </div>
  `
};

/* -----------------------------------------------------
   Dynamic fields + presets wiring
------------------------------------------------------ */
function updateDynamicFields() {
  const type = document.getElementById("resourceType").value;
  const container = document.getElementById("dynamicFields");
  container.innerHTML = dynamicFieldTemplates[type] || "";
}

function populatePresetOptions() {
  const type = document.getElementById("resourceType").value;
  const presetSelect = document.getElementById("examplePreset");
  presetSelect.innerHTML = "";
  (examples[type] || []).forEach(ex => {
    const opt = document.createElement("option");
    opt.value = ex.code;
    opt.textContent = `${ex.display} (${ex.code})`;
    presetSelect.appendChild(opt);
  });
}

function loadPreset() {
  const type = document.getElementById("resourceType").value;
  const presetCode = document.getElementById("examplePreset").value;
  const presetList = examples[type] || [];
  const preset = presetList.find(x => x.code == presetCode);
  if (!preset) return;

  // Basic fields
  document.getElementById("customCode").value = preset.code || "";
  document.getElementById("customDisplay").value = preset.display || "";

  // Value / unit
  if (preset.value && document.getElementById("valueField"))
    document.getElementById("valueField").value = preset.value;
  if (preset.value && document.getElementById("obsValue"))
    document.getElementById("obsValue").value = preset.value;
  if (preset.unit && document.getElementById("obsUnit"))
    document.getElementById("obsUnit").value = preset.unit;

  // Allergy-specific
  if (type === "AllergyIntolerance") {
    if (document.getElementById("allergyCategory"))
      document.getElementById("allergyCategory").value = preset.category || "food";
    if (document.getElementById("allergySeverity"))
      document.getElementById("allergySeverity").value = preset.severity || "mild";
  }

  // MedicationRequest dosage
  if (type === "MedicationRequest" && preset.dose) {
    if (document.getElementById("medReqDosage"))
      document.getElementById("medReqDosage").value = preset.dose;
  }

  // Appointment description
  if (type === "Appointment") {
    if (document.getElementById("apptDescription"))
      document.getElementById("apptDescription").value = preset.display;
  }
}

/* Resource type change */
document.getElementById("resourceType").addEventListener("change", () => {
  updateDynamicFields();
  populatePresetOptions();
  setTimeout(loadPreset, 0);
});

document.getElementById("examplePreset").addEventListener("change", () => {
  loadPreset();
});

/* Initial setup */
updateDynamicFields();
populatePresetOptions();
setTimeout(loadPreset, 0);

/* -----------------------------------------------------
   Resource builder (now per-entry)
------------------------------------------------------ */
function buildResourceFromEntry(entry, patientId, practitionerId) {
  const {
    type,
    code,
    display,
    date,
    generalVal,
    allergyCategory,
    allergyCriticality,
    allergySeverity,
    allergyReactionText,
    procedureStatus,
    conditionStatus,
    conditionVerification,
    medReqIntent,
    medReqDosage,
    obsValue,
    obsUnit,
    apptStatus,
    apptDescription
  } = entry;

  const today = new Date().toISOString().split("T")[0];
  const dateVal = date || today;
  const c = code || "999999";
  const d = display || type;

  switch(type) {
    case "AllergyIntolerance":
      return {
        resourceType:"AllergyIntolerance",
        clinicalStatus:{ coding:[{ system:"http://terminology.hl7.org/CodeSystem/allergyintolerance-clinical", code:"active" }] },
        verificationStatus:{ coding:[{ system:"http://terminology.hl7.org/CodeSystem/allergyintolerance-verification", code:"confirmed"}] },
        category:[ allergyCategory || "food" ],
        criticality: allergyCriticality || "low",
        code:{ coding:[{ system:"http://snomed.info/sct", code:c, display:d }] },
        patient:{ reference:`Patient/${patientId}` },
        reaction:[{
          severity: allergySeverity || "moderate",
          description: allergyReactionText || ""
        }]
      };

    case "Procedure":
      return {
        resourceType:"Procedure",
        status: procedureStatus || "completed",
        code:{ coding:[{ system:"http://snomed.info/sct", code:c, display:d }] },
        subject:{ reference:`Patient/${patientId}` },
        performedDateTime: dateVal
      };

    case "Immunization":
      return {
        resourceType:"Immunization",
        status:"completed",
        vaccineCode:{ coding:[{ system:"http://hl7.org/fhir/sid/cvx", code:c, display:d }] },
        patient:{ reference:`Patient/${patientId}` },
        occurrenceDateTime: dateVal,
        primarySource:true
      };

    case "Condition":
      return {
        resourceType:"Condition",
        clinicalStatus:{ coding:[{ system:"http://terminology.hl7.org/CodeSystem/condition-clinical", code:conditionStatus || "active" }] },
        verificationStatus:{ coding:[{ system:"http://terminology.hl7.org/CodeSystem/condition-verification", code:conditionVerification || "confirmed" }] },
        code:{ coding:[{ system:"http://snomed.info/sct", code:c, display:d }] },
        subject:{ reference:`Patient/${patientId}` },
        onsetDateTime: dateVal
      };

    case "MedicationRequest":
      return {
        resourceType:"MedicationRequest",
        status:"active",
        intent: medReqIntent || "order",
        medicationCodeableConcept:{ coding:[{ system:"http://www.nlm.nih.gov/research/umls/rxnorm", code:c, display:d }] },
        subject:{ reference:`Patient/${patientId}` },
        authoredOn: dateVal,
        dosageInstruction:[{ text: medReqDosage || generalVal || "As directed" }]
      };

    case "MedicationStatement":
      return {
        resourceType:"MedicationStatement",
        status:"active",
        medicationCodeableConcept:{ coding:[{ system:"http://www.nlm.nih.gov/research/umls/rxnorm", code:c, display:d }] },
        subject:{ reference:`Patient/${patientId}` },
        effectiveDateTime: dateVal
      };

    case "Observation": {
      const v = parseFloat(obsValue || generalVal || "0");
      const unit = obsUnit || "%";
      return {
        resourceType:"Observation",
        status:"final",
        code:{ coding:[{ system:"http://loinc.org", code:c, display:d }] },
        subject:{ reference:`Patient/${patientId}` },
        effectiveDateTime: dateVal,
        valueQuantity:{
          value: v,
          unit,
          system:"http://unitsofmeasure.org"
        }
      };
    }

    case "Appointment":
      return {
        resourceType:"Appointment",
        status: apptStatus || "booked",
        description: apptDescription || d,
        start:`${dateVal}T09:00:00Z`,
        end:`${dateVal}T09:30:00Z`,
        participant:[
          { actor:{ reference:`Patient/${patientId}` }, status:"accepted" },
          practitionerId ? { actor:{ reference:`Practitioner/${practitionerId}` }, status:"accepted" } : null
        ].filter(Boolean)
      };

    default:
      throw new Error("Unsupported resource type: " + type);
  }
}

/* -----------------------------------------------------
   Bundle resource list
------------------------------------------------------ */
const bundleResources = [];

function refreshBundleList() {
  const box = document.getElementById("resourceList");
  if (!bundleResources.length) {
    box.innerHTML = "<em>No resources added yet.</em>";
    return;
  }
  box.innerHTML = bundleResources
    .map((r,i)=>`<div class="resource-item">#${i+1} ‚Äî ${r.type} (${r.display || r.code || ""})</div>`)
    .join("");
}

document.getElementById("addResourceBtn").addEventListener("click", () => {
  const type = document.getElementById("resourceType").value;
  const entry = {
    type,
    code: valOr("customCode",""),
    display: valOr("customDisplay",""),
    date: valOr("dateValue",""),
    generalVal: valOr("valueField",""),
    allergyCategory: valOr("allergyCategory",""),
    allergyCriticality: valOr("allergyCriticality",""),
    allergySeverity: valOr("allergySeverity",""),
    allergyReactionText: valOr("allergyReactionText",""),
    procedureStatus: valOr("procedureStatus",""),
    conditionStatus: valOr("conditionStatus",""),
    conditionVerification: valOr("conditionVerification",""),
    medReqIntent: valOr("medReqIntent",""),
    medReqDosage: valOr("medReqDosage",""),
    obsValue: valOr("obsValue",""),
    obsUnit: valOr("obsUnit",""),
    apptStatus: valOr("apptStatus",""),
    apptDescription: valOr("apptDescription","")
  };
  bundleResources.push(entry);
  refreshBundleList();
});

/* -----------------------------------------------------
   Generate Bundle
------------------------------------------------------ */
function uuidFallback() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

document.getElementById("generateBtn").addEventListener("click", () => {
  const baseUrl = valOr("baseUrl","https://hapi.fhir.org/baseR4");
  const patientId = valOr("patientId","");
  const practitionerId = valOr("practitionerId","");
  const bundleType = valOr("bundleType","transaction");

  if (!patientId) {
    alert("Please enter a Patient ID.");
    return;
  }
  if (!bundleResources.length) {
    alert("Please add at least one resource to the bundle.");
    return;
  }

  let entries = [];
  try {
    entries = bundleResources.map(entry => {
      const res = buildResourceFromEntry(entry, patientId, practitionerId);
      const id = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : uuidFallback();
      return {
        fullUrl:`urn:uuid:${id}`,
        resource: res,
        request:{ method:"POST", url: entry.type }
      };
    });
  } catch (e) {
    console.error(e);
    alert("Error building resources: " + e.message);
    return;
  }

  const bundle = {
    resourceType:"Bundle",
    type:bundleType,
    entry: entries
  };

  const json = JSON.stringify(bundle, null, 2);
  document.getElementById("requestUrl").value = baseUrl;
  document.getElementById("requestBody").value = json;
  document.getElementById("curlCmd").value =
`curl -X POST \\
  -H "Content-Type: application/fhir+json" \\
  -d '${json.replace(/'/g,"'\\''")}' \\
  "${baseUrl}"`;
});

/* -----------------------------------------------------
   Clear All
------------------------------------------------------ */
document.getElementById("clearBtn").addEventListener("click", () => {
  bundleResources.length = 0;
  refreshBundleList();
  document.getElementById("requestUrl").value = "";
  document.getElementById("requestBody").value = "";
  document.getElementById("curlCmd").value = "";
});

/* -----------------------------------------------------
   Copy buttons
------------------------------------------------------ */
document.querySelectorAll(".copy-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const id = btn.getAttribute("data-copy");
    const el = document.getElementById(id);
    const text = el ? el.value : "";
    navigator.clipboard.writeText(text || "");
    btn.textContent = "Copied!";
    setTimeout(()=>btn.textContent="Copy", 1000);
  });
});

/* Initial list state */
refreshBundleList();
</script>

</body>
</html>
